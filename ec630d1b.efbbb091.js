(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{119:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return c})),t.d(n,"default",(function(){return p}));var r=t(3),i=t(7),a=(t(0),t(129)),o={title:"Asyncio Prices Downloader",slug:"/"},s={unversionedId:"prices_downloader",id:"prices_downloader",isDocsHomePage:!1,title:"Asyncio Prices Downloader",description:"The following is a demo to download historical prices given a list of ETF tickers from yahoo finance using asyncio.",source:"@site/docs/prices_downloader.md",slug:"/",permalink:"/docs/",version:"current",sidebar:"Quantitative Trading",next:{title:"yfinance Downloader",permalink:"/docs/quantitative_trading/yfinance-downloader"}},c=[{value:"Import the modules",id:"import-the-modules",children:[]}],l={toc:c};function p(e){var n=e.components,t=Object(i.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},l,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"The following is a demo to download historical prices given a list of ETF tickers from yahoo finance using asyncio."),Object(a.b)("h2",{id:"import-the-modules"},"Import the modules"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-python"}),"import os\nimport sys\nfrom datetime import datetime as dt\nimport asyncio\nfrom concurrent.futures import ProcessPoolExecutor\nimport pickle\nimport logging\n\n!{sys.executable} -m pip install yfinance\nimport yfinance\n")),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"Requirement already satisfied: yfinance in /opt/conda/lib/python3.6/site-packages (0.1.55)\nRequirement already satisfied: requests>=2.20 in /opt/conda/lib/python3.6/site-packages (from yfinance) (2.21.0)\nRequirement already satisfied: multitasking>=0.0.7 in /opt/conda/lib/python3.6/site-packages (from yfinance) (0.0.9)\nRequirement already satisfied: numpy>=1.15 in /opt/conda/lib/python3.6/site-packages (from yfinance) (1.19.5)\nRequirement already satisfied: pandas>=0.24 in /opt/conda/lib/python3.6/site-packages (from yfinance) (1.1.5)\nRequirement already satisfied: lxml>=4.5.1 in /opt/conda/lib/python3.6/site-packages (from yfinance) (4.6.2)\nRequirement already satisfied: certifi>=2017.4.17 in /opt/conda/lib/python3.6/site-packages (from requests>=2.20->yfinance) (2018.11.29)\nRequirement already satisfied: chardet<3.1.0,>=3.0.2 in /opt/conda/lib/python3.6/site-packages (from requests>=2.20->yfinance) (3.0.4)\nRequirement already satisfied: urllib3<1.25,>=1.21.1 in /opt/conda/lib/python3.6/site-packages (from requests>=2.20->yfinance) (1.24.1)\nRequirement already satisfied: idna<2.9,>=2.5 in /opt/conda/lib/python3.6/site-packages (from requests>=2.20->yfinance) (2.8)\nRequirement already satisfied: pytz>=2017.2 in /opt/conda/lib/python3.6/site-packages (from pandas>=0.24->yfinance) (2018.7)\nRequirement already satisfied: python-dateutil>=2.7.3 in /opt/conda/lib/python3.6/site-packages (from pandas>=0.24->yfinance) (2.7.5)\nRequirement already satisfied: six>=1.5 in /opt/conda/lib/python3.6/site-packages (from python-dateutil>=2.7.3->pandas>=0.24->yfinance) (1.12.0)\n")),Object(a.b)("p",null,"chunking a list of items into n-sized chunks"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-python"}),'def chunks(lst, n):\n    """Yield successive n-sized chunks from lst."""\n    for i in range(0, len(lst), n):\n        yield lst[i:i + n]\n')),Object(a.b)("p",null,"async fetch code to fetch data using yfinance module"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-python"}),"def fetch(tickers, data_dir, period):\n    errors = list()\n    for ticker in tickers:\n        try:\n            logging.debug('downloading %s' % ticker)\n            stock = yfinance.Ticker(ticker)\n            df = stock.history(period=period)\n            if not df.empty:\n                with open('%s/%s_prices.pkl' % (data_dir, ticker), 'wb') as output:\n                    pickle.dump(df, output, pickle.HIGHEST_PROTOCOL)\n        except Exception as ex:\n            logging.error(ex)\n            errors.append(ticker)\n            continue\n    return errors\n\n\nasync def async_fetch(tickers, data_dir, period):\n    result = await loop.run_in_executor(executor, fetch, tickers, data_dir, period)\n    return result\n\n\ndef run_async(ticker_lists, data_dir, period):\n    tasks = []\n    for tickers in ticker_lists:\n        tasks.append(loop.create_task(async_fetch(tickers, data_dir, period)))\n\n    done, _ = loop.run_until_complete(asyncio.wait(tasks))\n    all_errors = list()\n    for fut in done:\n        all_errors = all_errors + fut.result()\n    print(all_errors)\n    \n")),Object(a.b)("p",null,"main code to get started"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-python"}),"loop = asyncio.get_event_loop()\nexecutor = ProcessPoolExecutor(max_workers=10)\nworking_dir = os.getcwd()\ntickers = ['UVXY', 'SPY', 'SQQQ', 'XLF', 'VXX', 'EEM', 'SLV', 'TZA', 'TQQQ', 'QQQ', 'XLE', 'EWZ', 'IWM',\n          'HYG', 'GDX', 'IAU', 'EFA', 'FXI', 'LQD']\n\nstart_time = dt.now()\n\nticker_lists = chunks(tickers, 5)\n\nlogging.info(\"async run start\")\nrun_async(ticker_lists, working_dir, '6mo')\nlogging.info(\"async run finish\")\n\nend_time = dt.now()\n")),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"---------------------------------------------------------------------------\n\nRuntimeError                              Traceback (most recent call last)\n\n<ipython-input-4-80bb94ac23f3> in <module>\n     10 \n     11 logging.info(\"async run start\")\n---\x3e 12 run_async(ticker_lists, working_dir, '6mo')\n     13 logging.info(\"async run finish\")\n     14 \n\n\n<ipython-input-3-4857a1a7b258> in run_async(ticker_lists, data_dir, period)\n     26         tasks.append(loop.create_task(async_fetch(tickers, data_dir, period)))\n     27 \n---\x3e 28     done, _ = loop.run_until_complete(asyncio.wait(tasks))\n     29     all_errors = list()\n     30     for fut in done:\n\n\n/opt/conda/lib/python3.6/asyncio/base_events.py in run_until_complete(self, future)\n    458         future.add_done_callback(_run_until_complete_cb)\n    459         try:\n--\x3e 460             self.run_forever()\n    461         except:\n    462             if new_task and future.done() and not future.cancelled():\n\n\n/opt/conda/lib/python3.6/asyncio/base_events.py in run_forever(self)\n    412         self._check_closed()\n    413         if self.is_running():\n--\x3e 414             raise RuntimeError('This event loop is already running')\n    415         if events._get_running_loop() is not None:\n    416             raise RuntimeError(\n\n\nRuntimeError: This event loop is already running\n")))}p.isMDXComponent=!0},129:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return y}));var r=t(0),i=t.n(r);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=i.a.createContext({}),p=function(e){var n=i.a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},d=function(e){var n=p(e.components);return i.a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},f=i.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=p(t),f=r,y=d["".concat(o,".").concat(f)]||d[f]||u[f]||a;return t?i.a.createElement(y,s(s({ref:n},l),{},{components:t})):i.a.createElement(y,s({ref:n},l))}));function y(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=f;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<a;l++)o[l]=t[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,t)}f.displayName="MDXCreateElement"}}]);