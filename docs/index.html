<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Scott Tech Demos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Scott Tech Demos Blog Atom Feed"><title data-react-helmet="true">Asyncio Prices Downloader | Scott Tech Demos</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Asyncio Prices Downloader | Scott Tech Demos"><meta data-react-helmet="true" name="description" content="The following is a demo to download historical prices given a list of ETF tickers from yahoo finance using asyncio."><meta data-react-helmet="true" property="og:description" content="The following is a demo to download historical prices given a list of ETF tickers from yahoo finance using asyncio."><meta data-react-helmet="true" property="og:url" content="https://scottapp.github.io//docs/"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://scottapp.github.io//docs/"><link rel="stylesheet" href="/styles.412d942f.css">
<link rel="preload" href="/styles.158d0914.js" as="script">
<link rel="preload" href="/runtime~main.964a54e4.js" as="script">
<link rel="preload" href="/main.bb327f68.js" as="script">
<link rel="preload" href="/1.3e61523c.js" as="script">
<link rel="preload" href="/59.154e425e.js" as="script">
<link rel="preload" href="/60.a806e59f.js" as="script">
<link rel="preload" href="/935f2afb.0712ab80.js" as="script">
<link rel="preload" href="/58.60bc48f2.js" as="script">
<link rel="preload" href="/ec630d1b.0a6f03e7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Scott Tech Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="Scott Tech Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Scott Tech Demos</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Quantitative Trading</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/ai/docker-Deep-Learning-with-PyTorch-A-60-Minute-Blitz">AI</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/google_cloud/google-cloud-swagger-helloworld">Google Cloud</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/scottapp" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">My GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Scott Tech Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="Scott Tech Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Scott Tech Demos</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs">Quantitative Trading</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/ai/docker-Deep-Learning-with-PyTorch-A-60-Minute-Blitz">AI</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/google_cloud/google-cloud-swagger-helloworld">Google Cloud</a></li><li class="menu__list-item"><a href="https://github.com/scottapp" target="_blank" rel="noopener noreferrer" class="menu__link">My GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Download Prices</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/">Asyncio Prices Downloader</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/quantitative_trading/yfinance-downloader">yfinance Downloader</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Asyncio Prices Downloader</h1></header><div class="markdown"><p>The following is a demo to download historical prices given a list of ETF tickers from yahoo finance using asyncio.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="import-the-modules"></a>Import the modules<a class="hash-link" href="#import-the-modules" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> os</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> sys</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> datetime </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> datetime </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> dt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> asyncio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> concurrent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">futures </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> ProcessPoolExecutor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> pickle</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> logging</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">!</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">executable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">m pip install yfinance</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> yfinance</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: yfinance in /opt/conda/lib/python3.6/site-packages (0.1.55)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: requests&gt;=2.20 in /opt/conda/lib/python3.6/site-packages (from yfinance) (2.21.0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: multitasking&gt;=0.0.7 in /opt/conda/lib/python3.6/site-packages (from yfinance) (0.0.9)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: numpy&gt;=1.15 in /opt/conda/lib/python3.6/site-packages (from yfinance) (1.19.5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: pandas&gt;=0.24 in /opt/conda/lib/python3.6/site-packages (from yfinance) (1.1.5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: lxml&gt;=4.5.1 in /opt/conda/lib/python3.6/site-packages (from yfinance) (4.6.2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: certifi&gt;=2017.4.17 in /opt/conda/lib/python3.6/site-packages (from requests&gt;=2.20-&gt;yfinance) (2018.11.29)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: chardet&lt;3.1.0,&gt;=3.0.2 in /opt/conda/lib/python3.6/site-packages (from requests&gt;=2.20-&gt;yfinance) (3.0.4)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: urllib3&lt;1.25,&gt;=1.21.1 in /opt/conda/lib/python3.6/site-packages (from requests&gt;=2.20-&gt;yfinance) (1.24.1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: idna&lt;2.9,&gt;=2.5 in /opt/conda/lib/python3.6/site-packages (from requests&gt;=2.20-&gt;yfinance) (2.8)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: pytz&gt;=2017.2 in /opt/conda/lib/python3.6/site-packages (from pandas&gt;=0.24-&gt;yfinance) (2018.7)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: python-dateutil&gt;=2.7.3 in /opt/conda/lib/python3.6/site-packages (from pandas&gt;=0.24-&gt;yfinance) (2.7.5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requirement already satisfied: six&gt;=1.5 in /opt/conda/lib/python3.6/site-packages (from python-dateutil&gt;=2.7.3-&gt;pandas&gt;=0.24-&gt;yfinance) (1.12.0)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>chunking a list of items into n-sized chunks</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">chunks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">lst</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(195, 232, 141)">&quot;&quot;&quot;Yield successive n-sized chunks from lst.&quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">range</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">lst</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">yield</span><span class="token plain"> lst</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">i </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>async fetch code to fetch data using yfinance module</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    errors </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ticker </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            logging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;downloading %s&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">%</span><span class="token plain"> ticker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            stock </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> yfinance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Ticker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ticker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            df </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> stock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">history</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">period</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">not</span><span class="token plain"> df</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">empty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">open</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;%s/%s_prices.pkl&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">%</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> ticker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;wb&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    pickle</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">df</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> pickle</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">HIGHEST_PROTOCOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> ex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            logging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            errors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ticker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">continue</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> errors</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">async_fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    result </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> loop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run_in_executor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">executor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> result</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">run_async</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ticker_lists</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tasks </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> tickers </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> ticker_lists</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tasks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">loop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">create_task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">async_fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    done</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> _ </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> loop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run_until_complete</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">asyncio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tasks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    all_errors </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> fut </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> done</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        all_errors </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> all_errors </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> fut</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">all_errors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>main code to get started</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">get_event_loop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">executor </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> ProcessPoolExecutor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">max_workers</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">working_dir </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">getcwd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tickers </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;UVXY&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;SPY&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;SQQQ&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;XLF&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;VXX&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;EEM&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;SLV&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;TZA&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;TQQQ&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;QQQ&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;XLE&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;EWZ&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;IWM&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;HYG&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;GDX&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;IAU&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;EFA&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;FXI&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;LQD&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">start_time </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">now</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ticker_lists </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> chunks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;async run start&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">run_async</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ticker_lists</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> working_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;6mo&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;async run finish&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end_time </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">now</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---------------------------------------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RuntimeError                              Traceback (most recent call last)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ipython-input-4-80bb94ac23f3&gt; in &lt;module&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     10 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     11 logging.info(&quot;async run start&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---&gt; 12 run_async(ticker_lists, working_dir, &#x27;6mo&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     13 logging.info(&quot;async run finish&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     14 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ipython-input-3-4857a1a7b258&gt; in run_async(ticker_lists, data_dir, period)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     26         tasks.append(loop.create_task(async_fetch(tickers, data_dir, period)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     27 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---&gt; 28     done, _ = loop.run_until_complete(asyncio.wait(tasks))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     29     all_errors = list()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     30     for fut in done:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/opt/conda/lib/python3.6/asyncio/base_events.py in run_until_complete(self, future)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    458         future.add_done_callback(_run_until_complete_cb)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    459         try:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--&gt; 460             self.run_forever()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    461         except:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    462             if new_task and future.done() and not future.cancelled():</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/opt/conda/lib/python3.6/asyncio/base_events.py in run_forever(self)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    412         self._check_closed()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    413         if self.is_running():</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--&gt; 414             raise RuntimeError(&#x27;This event loop is already running&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    415         if events._get_running_loop() is not None:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    416             raise RuntimeError(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RuntimeError: This event loop is already running</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/quantitative_trading/yfinance-downloader"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">yfinance Downloader Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#import-the-modules" class="table-of-contents__link">Import the modules</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Links</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/scottapp" target="_blank" rel="noopener noreferrer" class="footer__link-item">My Github</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.158d0914.js"></script>
<script src="/runtime~main.964a54e4.js"></script>
<script src="/main.bb327f68.js"></script>
<script src="/1.3e61523c.js"></script>
<script src="/59.154e425e.js"></script>
<script src="/60.a806e59f.js"></script>
<script src="/935f2afb.0712ab80.js"></script>
<script src="/58.60bc48f2.js"></script>
<script src="/ec630d1b.0a6f03e7.js"></script>
</body>
</html>